<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰§æœ¬ç¼–è¾‘å™¨ - NINEå‰§ç»„</title>
    
    <!-- Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <!-- ä¸»æ ·å¼ -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/script-editor.css">
    
    <!-- ä¿®å¤BUGçš„CSS -->
    <style>
        /* ====== BUGä¿®å¤ï¼šé€æ˜åº¦å’Œå±‚å é—®é¢˜ ====== */
        
        /* 1. ä¿®å¤æ•´ä¸ªé¡µé¢èƒŒæ™¯ï¼Œé¿å…é€æ˜å åŠ  */
        body.script-editor-page {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%) !important;
            min-height: 100vh;
            padding: 20px;
        }
        
        /* 2. ä¿®å¤ç¼–è¾‘å™¨å®¹å™¨ - çº¯ç™½èƒŒæ™¯ï¼Œæ— é€æ˜ */
        .editor-wrapper {
            background: #FFFFFF !important;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #eaeaea;
        }
        
        /* 3. ä¿®å¤Quillå·¥å…·æ èƒŒæ™¯ */
        .ql-toolbar.ql-snow {
            background: #f8f9fa !important;
            border: 1px solid #dee2e6 !important;
            border-radius: 8px 8px 0 0;
            border-bottom: none !important;
        }
        
        /* 4. ä¿®å¤Quillç¼–è¾‘åŒºåŸŸ */
        .ql-container.ql-snow {
            background: #FFFFFF !important;
            border: 1px solid #dee2e6 !important;
            border-radius: 0 0 8px 8px;
            border-top: none !important;
            min-height: 400px;
            font-size: 16px;
            line-height: 1.6;
        }
        
        /* 5. ä¿®å¤å…¨å±æ¨¡å¼ - ç¡®ä¿èƒŒæ™¯ä¸é€æ˜ */
        .ql-editor.ql-blank::before,
        .ql-editor {
            color: #212529 !important;
            background: #FFFFFF !important;
        }
        
        /* å…¨å±æ¨¡å¼ä¸“ç”¨ä¿®å¤ */
        .ql-editor.fullscreen {
            background: #FFFFFF !important;
            z-index: 10000 !important;
            padding: 40px !important;
        }
        
        /* 6. ä¿®å¤å·²ä¿å­˜æç¤ºæŒ‰é’® */
        #saveIndicator {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: rgba(15, 15, 15, 0.95) !important;
            color: #6A11CB;
            padding: 12px 20px;
            border-radius: 10px;
            border: 2px solid #6A11CB;
            z-index: 9999;
            display: none;
            box-shadow: 0 6px 20px rgba(106, 17, 203, 0.4);
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: opacity 0.5s ease, transform 0.3s ease;
        }
        
        /* æŒ‰é’®æ¶ˆå¤±åŠ¨ç”» */
        #saveIndicator.fade-out {
            opacity: 0;
            transform: translateY(20px);
        }
        
        /* 7. ä¿®å¤è¡¨å•åŒºåŸŸ */
        .form-container {
            background: #FFFFFF !important;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #eaeaea;
            margin-bottom: 25px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }
        
        .form-input, .form-textarea {
            background: #FFFFFF !important;
            border: 1px solid #ced4da !important;
            color: #212529 !important;
        }
        
        /* 8. ä¿®å¤æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            background: #f8f9fa !important;
            border: 2px dashed #6A11CB !important;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
        }
        
        .upload-area.dragover {
            background: rgba(106, 17, 203, 0.1) !important;
        }
        
        /* 9. ä¿®å¤æ–‡ä»¶åˆ—è¡¨ */
        .file-list {
            background: #FFFFFF !important;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .file-item {
            background: #f8f9fa !important;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px 15px;
            margin-bottom: 8px;
        }
        
        /* 10. ä¿®å¤æŒ‰é’®åŒºåŸŸ */
        .action-buttons {
            background: #FFFFFF !important;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            text-align: center;
            border: 1px solid #eaeaea;
        }
        
        .btn-primary, .btn-secondary {
            background: linear-gradient(135deg, #6A11CB 0%, #2575FC 100%) !important;
            color: white !important;
            border: none !important;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            margin: 0 10px;
            min-width: 160px;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%) !important;
        }
        
        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(106, 17, 203, 0.3);
        }
        
        /* 11. ä¿®å¤é¡µé¢æ ‡é¢˜ */
        .page-title {
            color: #FFFFFF !important;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* 12. ç¡®ä¿æ‰€æœ‰æ–‡å­—æ¸…æ™°å¯è§ */
        * {
            color: inherit !important;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            body.script-editor-page {
                padding: 10px;
            }
            
            .editor-wrapper, .form-container {
                padding: 15px;
            }
            
            .action-buttons {
                padding: 15px;
            }
            
            .btn-primary, .btn-secondary {
                display: block;
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body class="script-editor-page">
    <!-- è¿”å›å¯¼èˆª -->
    <div class="container" style="margin-top: 20px;">
        <a href="groups.html" class="back-link" style="color: #6A11CB; text-decoration: none; font-size: 16px;">
            â† è¿”å›åˆ†ç»„é¡µé¢
        </a>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <h1 class="page-title">âœï¸ å‰§æœ¬ç¼–è¾‘å™¨</h1>
        
        <!-- å‰§æœ¬ä¿¡æ¯è¡¨å• -->
        <div class="form-container">
            <h2 style="color: #212529; margin-bottom: 20px;">ğŸ“ å‰§æœ¬ä¿¡æ¯</h2>
            
            <div class="form-group">
                <label for="scriptTitle" style="color: #495057; display: block; margin-bottom: 8px; font-weight: bold;">
                    å‰§æœ¬æ ‡é¢˜ *
                </label>
                <input type="text" id="scriptTitle" class="form-input" 
                       placeholder="è¯·è¾“å…¥å‰§æœ¬æ ‡é¢˜ï¼ˆå¦‚ï¼šæ˜Ÿæµ·ä¹‹çº¦ï¼‰" 
                       style="width: 100%; padding: 12px; border-radius: 6px;">
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label for="scriptDescription" style="color: #495057; display: block; margin-bottom: 8px; font-weight: bold;">
                    å‰§æœ¬ç®€ä»‹
                </label>
                <textarea id="scriptDescription" class="form-textarea" 
                          placeholder="ç®€è¦æè¿°å‰§æœ¬å†…å®¹ã€èƒŒæ™¯ã€ä¸»è¦è§’è‰²..." 
                          rows="4"
                          style="width: 100%; padding: 12px; border-radius: 6px;"></textarea>
            </div>
        </div>
        
        <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
        <div class="editor-wrapper">
            <h2 style="color: #212529; margin-bottom: 20px;">ğŸ“– å‰§æœ¬å†…å®¹</h2>
            <div id="editor-container">
                <!-- Quillç¼–è¾‘å™¨å°†åœ¨è¿™é‡Œåˆå§‹åŒ– -->
            </div>
        </div>
        
        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="form-container">
            <h2 style="color: #212529; margin-bottom: 20px;">ğŸ“ é™„ä»¶ä¸Šä¼ </h2>
            <p style="color: #6c757d; margin-bottom: 15px;">æ”¯æŒ .txt, .docx, .pdf ç­‰æ–‡æ¡£æ ¼å¼ï¼ˆå¯é€‰ï¼‰</p>
            
            <div class="upload-area" id="uploadArea">
                <div style="font-size: 48px; color: #6A11CB; margin-bottom: 15px;">ğŸ“¤</div>
                <p style="color: #495057; font-size: 18px; margin-bottom: 10px;">
                    æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
                </p>
                <p style="color: #6c757d; font-size: 14px;">
                    æ”¯æŒå•ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ä¸Šä¼ 
                </p>
                <input type="file" id="fileInput" multiple 
                       style="display: none;" 
                       accept=".txt,.doc,.docx,.pdf,.md">
                <button onclick="document.getElementById('fileInput').click()" 
                        class="btn-secondary" 
                        style="margin-top: 15px; padding: 10px 20px; font-size: 14px;">
                    é€‰æ‹©æ–‡ä»¶
                </button>
            </div>
            
            <div class="file-list" id="fileList">
                <!-- æ–‡ä»¶åˆ—è¡¨å°†åŠ¨æ€æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-buttons">
            <button onclick="saveDraft()" class="btn-secondary">
                ğŸ’¾ ä¿å­˜è‰ç¨¿
            </button>
            <button onclick="submitScript()" class="btn-primary">
                ğŸš€ æäº¤å®¡æ ¸
            </button>
        </div>
    </div>
    
    <!-- ä¿å­˜æç¤º -->
    <div id="saveIndicator">âœ… å·²ä¿å­˜è‰ç¨¿</div>

    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <!-- ä¿®å¤åçš„è„šæœ¬ -->
    <script>
        // åˆå§‹åŒ–Quillç¼–è¾‘å™¨
        const quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link', 'image', 'video'],
                    ['clean'],
                    ['fullscreen']
                ]
            },
            placeholder: 'å¼€å§‹åˆ›ä½œä½ çš„å‰§æœ¬...æ”¯æŒæ–‡å­—æ ¼å¼ã€å›¾ç‰‡ã€é“¾æ¥ç­‰'
        });
        
        // æ–‡ä»¶ä¸Šä¼ ç›¸å…³å˜é‡
        let uploadedFiles = [];
        
        // åˆå§‹åŒ– - åŠ è½½è‰ç¨¿
        document.addEventListener('DOMContentLoaded', function() {
            loadDraft();
            setupFileUpload();
            setupAutoSave();
        });
        
        // åŠ è½½è‰ç¨¿
        function loadDraft() {
            const draft = localStorage.getItem('scriptDraft');
            if (draft) {
                try {
                    const data = JSON.parse(draft);
                    document.getElementById('scriptTitle').value = data.title || '';
                    document.getElementById('scriptDescription').value = data.description || '';
                    if (data.content) {
                        quill.root.innerHTML = data.content;
                    }
                    uploadedFiles = data.files || [];
                    updateFileList();
                    showSaveIndicator('ğŸ“‚ å·²åŠ è½½è‰ç¨¿');
                } catch (e) {
                    console.error('åŠ è½½è‰ç¨¿å¤±è´¥:', e);
                }
            }
        }
        
        // è‡ªåŠ¨ä¿å­˜ï¼ˆæ¯30ç§’ï¼‰
        function setupAutoSave() {
            setInterval(() => {
                const title = document.getElementById('scriptTitle').value;
                const description = document.getElementById('scriptDescription').value;
                const content = quill.root.innerHTML;
                
                if (title.trim() || content.trim() !== '<p><br></p>') {
                    const scriptData = {
                        title: title,
                        description: description,
                        content: content,
                        files: uploadedFiles,
                        savedAt: new Date().toISOString()
                    };
                    
                    localStorage.setItem('scriptDraft', JSON.stringify(scriptData));
                    showSaveIndicator('âœ… å·²è‡ªåŠ¨ä¿å­˜');
                }
            }, 30000); // 30ç§’
        }
        
        // æ‰‹åŠ¨ä¿å­˜è‰ç¨¿
        function saveDraft() {
            const title = document.getElementById('scriptTitle').value;
            const description = document.getElementById('scriptDescription').value;
            const content = quill.root.innerHTML;
            
            const scriptData = {
                title: title,
                description: description,
                content: content,
                files: uploadedFiles,
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem('scriptDraft', JSON.stringify(scriptData));
            showSaveIndicator('âœ… è‰ç¨¿å·²ä¿å­˜');
        }
        
        // æ˜¾ç¤ºä¿å­˜æç¤ºï¼ˆ3ç§’åè‡ªåŠ¨æ¶ˆå¤±ï¼‰
        function showSaveIndicator(message) {
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = message;
            indicator.style.display = 'block';
            indicator.style.opacity = '1';
            indicator.classList.remove('fade-out');
            
            // 3ç§’åå¼€å§‹æ·¡å‡º
            setTimeout(() => {
                indicator.classList.add('fade-out');
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 500);
            }, 3000);
        }
        
        // æ–‡ä»¶ä¸Šä¼ è®¾ç½®
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            
            // ç‚¹å‡»ä¸Šä¼ 
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
                fileInput.value = ''; // é‡ç½®input
            });
        }
        
        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
        function handleFiles(files) {
            for (let file of files) {
                // æ¨¡æ‹Ÿä¸Šä¼ ï¼ˆå®é™…é¡¹ç›®éœ€è¦ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰
                const fileInfo = {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    size: formatFileSize(file.size),
                    type: file.type,
                    uploadedAt: new Date().toLocaleString()
                };
                uploadedFiles.push(fileInfo);
            }
            updateFileList();
            saveDraft(); // ä¿å­˜æ–‡ä»¶åˆ—è¡¨åˆ°è‰ç¨¿
        }
        
        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
        function updateFileList() {
            const fileListEl = document.getElementById('fileList');
            
            if (uploadedFiles.length === 0) {
                fileListEl.innerHTML = '<p style="color: #6c757d; text-align: center;">æš‚æ— ä¸Šä¼ æ–‡ä»¶</p>';
                return;
            }
            
            fileListEl.innerHTML = uploadedFiles.map(file => `
                <div class="file-item" data-id="${file.id}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #212529;">${file.name}</strong>
                            <br>
                            <small style="color: #6c757d;">${file.size} â€¢ ${file.uploadedAt}</small>
                        </div>
                        <button onclick="removeFile('${file.id}')" 
                                style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 18px;">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // ç§»é™¤æ–‡ä»¶
        function removeFile(fileId) {
            uploadedFiles = uploadedFiles.filter(file => file.id !== fileId);
            updateFileList();
            saveDraft();
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // æäº¤å‰§æœ¬ï¼ˆæ¨¡æ‹Ÿï¼‰
        function submitScript() {
            const title = document.getElementById('scriptTitle').value.trim();
            const content = quill.root.innerHTML;
            
            if (!title) {
                alert('è¯·å¡«å†™å‰§æœ¬æ ‡é¢˜');
                return;
            }
            
            if (content === '<p><br></p>' || content.trim() === '<p></p>') {
                alert('è¯·å¡«å†™å‰§æœ¬å†…å®¹');
                return;
            }
            
            if (confirm(`ç¡®å®šæäº¤å‰§æœ¬ "${title}" è¿›è¡Œå®¡æ ¸å—ï¼Ÿ\n\næäº¤åï¼Œç»„é•¿å°†åœ¨24å°æ—¶å†…è¿›è¡Œå®¡æ ¸ã€‚`)) {
                // è¿™é‡Œå®é™…åº”è¯¥å‘é€åˆ°æœåŠ¡å™¨
                console.log('æäº¤å‰§æœ¬:', {
                    title: title,
                    description: document.getElementById('scriptDescription').value,
                    content: content,
                    files: uploadedFiles
                });
                
                // æ¸…ç©ºè‰ç¨¿
                localStorage.removeItem('scriptDraft');
                uploadedFiles = [];
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert('âœ… å‰§æœ¬æäº¤æˆåŠŸï¼\n\nå·²è¿›å…¥å®¡æ ¸é˜Ÿåˆ—ï¼Œå®¡æ ¸ç»“æœå°†é€šè¿‡ç³»ç»Ÿé€šçŸ¥ã€‚');
                
                // è·³è½¬åˆ°æˆ‘çš„å‰§æœ¬é¡µé¢ï¼ˆå¾…å¼€å‘ï¼‰
                window.location.href = 'groups.html'; // æš‚æ—¶è¿”å›åˆ†ç»„é¡µ
            }
        }
    </script>
</body>
</html>
